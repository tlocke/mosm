<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- 

    This file is part of MOSM.

    MOSM is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    MOSM is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with MOSM.  If not, see <http://www.gnu.org/licenses/>.

 -->
 
<title>OpenStreetMap</title>

<!-- bring in the OpenLayers javascript library
         (here we bring it from the remote site, but you could
         easily serve up this javascript yourself) -->
<script src="http://www.openlayers.org/api/OpenLayers.js"></script>

<!-- bring in the OpenStreetMap OpenLayers layers.
         Using this hosted file will make sure we are kept up
         to date with any necessary changes -->
<script src="http://www.openstreetmap.org/openlayers/OpenStreetMap.js"></script>
<script type="text/javascript" src="gears_init.js"></script>
<script type="text/javascript">
 // Request repeated updates.
        var lat=51.508;
        var lon=-0.118;
        var zoom=13;
    	var geo = null;


        
        var map; //complex object of type OpenLayers.Map

       
        function log(message) {
            ulElement = document.getElementById('log');
        	listElement = document.createElement("li");
        	listElement.textContent = message;
        	ulElement.appendChild(listElement);
        	if (ulElement.childNodes.length > 10) {
            	ulElement.removeChild(ulElement.firstChild);
        	}
        }
    function updatePosition(position) {
     log("Updating position: lat " + position.latitude + " lon " + position.longitude + " alt " +
    	      position.altitude + " accuracy " + position.accuracy + " altitude accuracy " + position.altitudeAccuracy +
    	      " heading " + position.heading + " speed " + position.speed);   
    	  var lonLat = new OpenLayers.LonLat(position.longitude, position.latitude).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
          map.panTo(lonLat);
    	}

    	function handleError(positionError) {
    	  log('Attempt to get location failed: ' + positionError.message + ' error code ' + positionError.code);
    	}

        // Start position for the map (hardcoded here for simplicity)
 
        //Initialise the 'map' object
        function init() {
        	
        	try {
        		geo = navigator.geolocation;
        	} catch (e) {
        	}
        	
        	if (geo == null) {
        		try {
        		geo = google.gears.factory.create('beta.geolocation');
        		} catch (e) {
        		}
        		if (geo == null) {
        			alert("Can't get GEO");
        		}
        	} 
   	   var watchId = geo.watchPosition(updatePosition, handleError);
                     	
            map = new OpenLayers.Map ("map", {
                controls:[
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                    new OpenLayers.Control.Attribution()],
                maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                maxResolution: 156543.0399,
                numZoomLevels: 19,
                units: 'm',
                projection: new OpenLayers.Projection("EPSG:900913"),
                displayProjection: new OpenLayers.Projection("EPSG:4326")
            } );
 
 
            // Define the map layer
            // Other defined layers are OpenLayers.Layer.OSM.Mapnik, OpenLayers.Layer.OSM.Maplint and OpenLayers.Layer.OSM.CycleMap
            layerTilesAtHome = new OpenLayers.Layer.OSM.Osmarender("Osmarender");
            map.addLayer(layerTilesAtHome);
 
            if( ! map.getCenter() ){
                var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
                map.setCenter (lonLat, zoom);
            }
        }

        function getCurrentPosition() {
			geo.getCurrentPosition(updatePosition, handleError);         	
        }

    </script>

</head>

<!-- body.onload is called once the page is loaded (call the 'init' function) -->
<body onload="init();">

<!-- define a DIV into which the map will appear. Make it take up the whole window -->
<div style="width: 100%; height: 90%" id="map"></div>
<form>
<input type="button" value="Get Position" onclick="getCurrentPosition();"/>
</form>
<ul id="log">
<li>Starting Log</li>
</ul>
<p>Please send bugs and feature requests to <a href="mailto:tlocke@tlocke.org.uk">tlocke@tlocke.org.uk</a></p>

</body>
</html>